# ЛР-1 — Функциональные требования к «Песочнице юридических правок»

## 1. Назначение и границы

Приложение (Frontend MVP) позволяет загрузить/вставить текст договора, разрезать его на пункты, выявить **дубли** и **конфликты** между пунктами, просмотреть результаты, помечать найденное как решённое и **экспортировать отчёт**.
В ЛР-1 **всё выполняется на клиенте** (без реального backend-анализа).

## 2. Термины и сущности

* **Пункт (Clause)** — фрагмент текста договора с индексом `index` и текстом `text`.
* **Находка (Finding)** — результат анализа:

  * **Дубль (Duplicate)** — пара пунктов, похожих по содержанию.
  * **Конфликт (Conflict)** — пара пунктов с противоречивым смыслом.
* **Порог похожести** — численное значение `[0.60…0.98]` (по умолчанию `0.85`) для определения дублей.

## 3. Пользовательские сценарии (US)

* **US-01**: Пользователь вставляет текст либо загружает `.txt/.md`.
* **US-02**: Пользователь запускает сегментацию текста на пункты.
* **US-03**: Пользователь запускает анализ и видит список дублей/конфликтов.
* **US-04**: Пользователь переходит от находки к соответствующим пунктам (скролл/подсветка).
* **US-05**: Пользователь помечает находку «решено» и при желании скрывает/отображает решённые.
* **US-06**: Пользователь настраивает порог похожести и повторяет анализ.
* **US-07**: Пользователь экспортирует отчёт в **Markdown** и/или **JSON**.
* **US-08**: Пользователь возвращается на страницу и видит ранее введённый текст (localStorage).
* **US-09**: Пользователь подгружает демо-текст для проверки.

## 4. Функциональные требования (FR)

### Ввод/вывод данных

* **FR-01**: Приложение должно принимать текст договора через:

  * поле ввода (вставка буфера обмена),
  * загрузку файла `.txt` или `.md`.
* **FR-02**: При загрузке файла содержимое должно подставляться в поле ввода.
* **FR-03**: Кнопка «Демо-текст» должна заполнять поле тестовыми данными.

### Сегментация

* **FR-04**: По кнопке «Сегментировать» приложение разбивает текст на пункты.
* **FR-05**: Базовое правило сегментации: заголовки вида `N.` / `N)` / `Пункт/Статья/Раздел N`.
  Фоллбэки:

  * по пустым строкам (абзацам),
  * по предложениям (разделителям `.?!` и заглавным буквам).
* **FR-06**: Каждый пункт получает порядковый **индекс** начиная с `1` и отображается в карточке.
* **FR-07**: Отображаются **счётчики**: количество пунктов и количество находок.

### Анализ: дубли и конфликты (локально)

* **FR-08**: Пользователь может установить **порог похожести** дублей в диапазоне `[0.60…0.98]`, по умолчанию `0.85`.
* **FR-09**: Дубли определяются на основе **Jaccard-похожести** по токенам без стоп-слов (русский язык).
* **FR-10**: Конфликты определяются по эвристикам при близости темы пунктов:

  * **Полярность**: присутствие пар «разрешено/запрещено» в разных пунктах одной темы.
  * **Модальность**: «должен/обязан/может/вправе» vs «не должен/не обязан/не может/не вправе».
  * **Числа**: существенные расхождения (≥50%) в численных значениях при совпадении контекста (напр. «10 дней» vs «30 дней»).
* **FR-11**: Для каждой находки отображаются: тип (дубль/конфликт), краткая причина, **серьёзность** (низкая/средняя/высокая), служебные индексы задействованных пунктов.
* **FR-12**: Клик по находке должен фокусировать соответствующие пункты: скролл к первому и подсветка обоих.

### Управление списком находок

* **FR-13**: Пользователь может **пометить** находку как «решённая».
* **FR-14**: Переключатель «Показывать решённые» должен включать/скрывать такие находки в списке.
* **FR-15**: (Опционально) Пользователь может «скрыть из списка» отдельную находку до обновления анализа.

### Экспорт/импорт и состояние

* **FR-16**: Экспорт **Markdown** должен содержать: дату, перечень пунктов, перечень находок (с типом и серьёзностью).
* **FR-17**: Экспорт **JSON** должен содержать: список пунктов, список находок, установленный порог похожести, временную метку генерации.
* **FR-18**: Введённый пользователем текст сохраняется в **localStorage** и восстанавливается при повторном открытии страницы.
* **FR-19**: Кнопка «Очистить» должна сбрасывать: поле ввода, список пунктов, список находок, текущее выделение.

### Навигация/интерфейс

* **FR-20**: Интерфейс состоит минимум из трёх областей: редактор текста, список находок (с фильтрами), перечень пунктов.
* **FR-21**: Для каждого типа находок доступны отдельные вкладки «Все / Дубли / Конфликты».
* **FR-22**: Визуально выделяются **серьёзности** (низкая/средняя/высокая) и типы находок (бейджи).

### Ограничения и рамки ЛР-1

* **FR-23**: Анализ выполняется **целиком в браузере**; сетевые запросы к API **не обязательны**.
* **FR-24**: Страница доступна по маршруту `/legal/sandbox` (или `/sandbox`, если так принято в проекте).
* **FR-25**: Публикация кода в GitHub — обязательное условие приёмки.

## 5. Форматы данных (для экспорта)

**Clause (пункт):**

```json
{ "index": 1, "text": "Текст пункта", "header": "1.", "tags": [] }
```

**Finding (пример дубля):**

```json
{
  "id": "dup_abcd123",
  "type": "duplicate",
  "items": [1, 2],
  "similarity": 0.93,
  "severity": "high",
  "reason": "Пункты 1 и 2 дублируют друг друга (похожесть 93%).",
  "resolved": false
}
```

**Finding (пример конфликта):**

```json
{
  "id": "conf_xy12",
  "type": "conflict",
  "a": 3,
  "b": 4,
  "signal": "numbers",
  "severity": "medium",
  "reason": "Различие сроков оплаты 10 vs 30 дней.",
  "resolved": false
}
```

## 6. Обработка ошибок/границы

* Пустой ввод текста — анализ не запускается, показывается подсказка сегментации.
* Невалидный файл (не `.txt/.md`) — показать сообщение и не менять текущий текст.
* При изменении порога похожести новый анализ должен пересчитать список находок.
* При «Очистить» страница возвращается в исходное состояние без перезагрузки.

## 7. Критерии приёмки (чек-лист)

* [ ] Текст можно **вставить** и/или **загрузить** из файла.
* [ ] «Сегментировать» создаёт **несколько** пунктов на демо-тексте.
* [ ] «Найти конфликты и дубли» на демо-тексте даёт **≥1 дубля** и **≥1 конфликта**.
* [ ] Изменение порога похожести влияет на список дублей.
* [ ] Клик по находке скроллит/подсвечивает соответствующие пункты.
* [ ] Можно помечать «Решено» и переключать «Показывать решённые».
* [ ] Экспорт **MD** и **JSON** формирует корректные файлы.
* [ ] При перезагрузке страницы введённый текст восстанавливается (localStorage).
* [ ] Код проекта доступен в GitHub, собирается на CI фронта.

## 4. Нефункциональные требования (NFR)

### 4.1 Производительность

* **NFR-01**: Анализ текста объёмом **до 10 000 символов** выполняется **≤ 1.5 с** на среднем ноутбуке (Chrome/Edge, dev-сборка).
* **NFR-02**: Скролл и взаимодействие со списком **до 200 пунктов** — плавные (≈60 fps на десктопе; без фризов >100 мс).
* **NFR-03**: Память вкладки браузера при типовом сценарии **≤ 200 МБ**; утечек памяти нет (повторные запуски анализа не наращивают использование памяти).

### 4.2 Надёжность и устойчивость

* **NFR-04**: Пустой ввод/невалидный файл **не приводят к падению**; показывается понятная подсказка/ошибка.
* **NFR-05**: Все исключения в обработчиках файлов и парсинге **перехвачены**; в консоли отсутствуют **ошибки** (warnings допустимы).
* **NFR-06**: Состояние UI **восстанавливается** из `localStorage`; при повреждённых данных — безопасный сброс к дефолту.

### 4.3 Удобство (UX)

* **NFR-07**: Интерфейс **адаптивный**: корректно работает от **360 px** ширины (мобилки) до десктопа.
* **NFR-08**: Основные действия доступны **≤ 2 кликов**: вставка/загрузка → сегментация → анализ → переход к пунктам.
* **NFR-09**: Управление порогом дублей очевидно: подпись, диапазон, мгновимый пересчёт при изменении.

### 4.4 Доступность (A11y)

* **NFR-10**: У интерактивных элементов есть **текстовые метки** (иконки не единственный индикатор).
* **NFR-11**: **Фокус** видим; навигация по клавиатуре работает для кнопок/вкладок.
* **NFR-12**: Цвета бейджей и подсветка имеют достаточный **контраст** (ориентир WCAG AA).

### 4.5 Безопасность и конфиденциальность

* **NFR-13**: В ЛР-1 **нет сетевых отправок** пользовательского текста; всё выполняется локально (кроме загрузки UI-стилей/lib из node_modules).
* **NFR-14**: Нет сторонней аналитики/трекеров. В `localStorage` хранится **только** пользовательский текст песочницы; сторонних cookies нет.
* **NFR-15**: Экспорт **MD/JSON** создаётся **только локально** (через `Blob`/`URL.createObjectURL`), без аплоада.

### 4.6 Совместимость и окружение

* **NFR-16**: Поддерживаемые браузеры (актуальные стабильные): **Chrome** и **Edge**; **Firefox** — best effort.
* **NFR-17**: Dev-окружение: **Node.js 20+**, **npm 10+**, Windows 10/11.
* **NFR-18**: Сборка и запуск фронта (`npm run build`, `npm run dev`) проходят без ошибок на чистой машине.
* **NFR-19**: **Известное ограничение Windows**: путь проекта должен быть **без пробелов и не-ASCII** символов (например, `C:\dev\legal-sandbox`). При проблемах dev-сервера Turbopack допускается запуск с `--no-turbo`.

### 4.7 Качество кода и поддерживаемость

* **NFR-20**: Код — TypeScript + ESLint + Prettier; линт без ошибок на CI.
* **NFR-21**: Бизнес-логика (сегментация, токенизация, метрики) изолирована в **утилитах**; UI-компоненты без дубликатов логики.
* **NFR-22**: Отсутствуют **магические числа** без комментариев; для порогов есть константы/описание.
* **NFR-23**: Именование файлов/компонентов — единообразное (`PascalCase` для компонентов, `camelCase` для функций).

### 4.8 Логирование и диагностика

* **NFR-24**: В прод-сборке нет `console.log`/`debug`; в dev — только целевое логирование без личных данных.
* **NFR-25**: Ошибки пользователя (неподдерживаемый файл, пустой ввод) отображаются как **ненавязчивые уведомления**/подсказки в UI.

### 4.9 Документация и процессы

* **NFR-26**: `README.md` в корне описывает: требования к окружению, команды запуска/сборки, путь к странице песочницы, скриншоты.
* **NFR-27**: **CI GitHub Actions** для фронта: `npm ci` → `npm run build` → `npm run lint` — зелёный на PR в `main`.

### 4.10 Ограничения и «вне объёма» ЛР-1

* **NFR-28**: Нет серверного анализа/БД/авторизации.
* **NFR-29**: Нет импорта PDF/DOCX (только `.txt/.md`).
* **NFR-30**: Нет мультиязыка (интерфейс RU); тексты/бейджи — на русском.

---

### Критерии приёмки NFR (чек-лист)

* [ ] Анализ 10 000 символов ≤ 1.5 с; UI не зависает.
* [ ] Нет ошибок в консоли при типовом сценарии; пустой ввод/битый файл не ломают страницу.
* [ ] Интерфейс адаптивен (моб./десктоп), управление порогом интуитивно.
* [ ] Клавиатурная навигация и видимый фокус есть; контраст бейджей норм.
* [ ] Текст никуда не отправляется, экспорт — локальный.
* [ ] Браузеры Chrome/Edge ок; Node 20; `npm run build` успешен.
* [ ] Проектная папка без пробелов/кириллицы; при необходимости dev без Turbopack тоже работает.
* [ ] ESLint/Prettier проходят; структура кода модульная.
* [ ] README полон; CI фронта зелёный на PR.
